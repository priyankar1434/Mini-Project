<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vehicle Authorization Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: #f8f9fa;
            min-height: 100vh;
        }
        .navbar {
            background: #232526;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .card {
            background: rgba(44,44,44,0.95);
            border-radius: 1rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.25);
            border: none;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
        }
        .gallery-img {
            object-fit: cover;
            width: 100%;
            height: 180px;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            margin-bottom: 1rem;
        }
        .badge {
            font-size: 1rem;
            padding: 0.5em 1em;
            border-radius: 0.5em;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #f7f7f7;
        }
        .card-subtitle {
            font-size: 1rem;
            color: #b0b0b0;
        }
        .status-success {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #232526;
        }
        .status-danger {
            background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);
            color: #232526;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">--Vehicle Authorization System--</span>
    </div>
</nav>
<div class="container">
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <form id="uploadForm" enctype="multipart/form-data" class="p-4 card">
                <h4 class="mb-3 card-title">Upload Vehicle Image</h4>
                <input type="file" name="image" class="form-control mb-2" required>
                <input type="text" name="license_plate" class="form-control mb-2" placeholder="Enter License Plate (if known)">
                <button type="submit" class="btn btn-primary w-100">Upload & Scan</button>
            </form>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="card p-4">
                <h4 class="mb-3 card-title">Capture from Camera</h4>
                <video id="video" width="100%" height="180" autoplay style="border-radius:0.75rem; box-shadow:0 2px 8px rgba(0,0,0,0.15);"></video>
                <button id="captureBtn" class="btn btn-success mt-2 w-100">Capture & Upload</button>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
        </div>
    </div>
    <h3 class="mb-3 card-title">Recent Scans</h3>
    <div class="row" id="gallery">
        {% for filename, upload_time, plate, is_authorized in images %}
        <div class="col-md-4 mb-4">
            <div class="card p-3">
                <img src="{{ url_for('uploaded_file', filename=filename) }}" class="gallery-img" alt="Vehicle Image">
                <div>
                    <div class="card-title">{{ plate }}</div>
                    <div class="card-subtitle mb-2">Uploaded: {{ upload_time }}</div>
                    <span class="badge {% if is_authorized %}status-success{% else %}status-danger{% endif %}">
                        {% if is_authorized %}Authorized{% else %}Unauthorized{% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<audio id="siren" src="{{ url_for('static', filename='police-siren.mp3') }}"></audio>

<script>
document.getElementById('uploadForm').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/upload', { method: 'POST', body: formData });
    if (res.ok) {
        const data = await res.json();
        // Play siren for UNAUTHORIZED vehicles
        if (data.result && !data.result.is_authorized) {
            document.getElementById('siren').play();
        }
        location.reload();
    } else {
        alert('Upload failed!');
    }
};

// Camera capture logic
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        video.srcObject = stream;
        video.play();
    });
}

captureBtn.onclick = async function() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(async function(blob) {
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');
        formData.append('license_plate', prompt('Enter License Plate:'));
        const res = await fetch('/upload', { method: 'POST', body: formData });
        if (res.ok) {
            const data = await res.json();
            // Play siren for UNAUTHORIZED vehicles
            if (data.result && !data.result.is_authorized) {
                document.getElementById('siren').play();
            }
            location.reload();
        } else {
            alert('Camera upload failed!');
        }
    }, 'image/jpeg');
};
</script>
</body>
</html>